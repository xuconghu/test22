<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº‘æœåŠ¡å™¨ä¸Šä¼ æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            font-size: 1.1em;
        }
        
        input[type="text"], textarea {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            box-sizing: border-box;
        }
        
        textarea {
            height: 120px;
            resize: vertical;
        }
        
        button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            font-weight: bold;
            display: none;
        }
        
        .success {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid #4caf50;
            color: #4caf50;
        }
        
        .error {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid #f44336;
            color: #f44336;
        }
        
        .info {
            background: rgba(33, 150, 243, 0.2);
            border: 1px solid #2196f3;
            color: #2196f3;
        }
        
        .server-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ äº‘æœåŠ¡å™¨ä¸Šä¼ æµ‹è¯•</h1>
        
        <div class="server-info">
            <strong>ğŸ“ ç›®æ ‡æœåŠ¡å™¨:</strong> 106.15.184.68<br>
            <strong>ğŸ“ ä¸Šä¼ è·¯å¾„:</strong> /var/www/candy-game/data/<br>
            <strong>ğŸ”— API ç«¯ç‚¹:</strong> /api/upload-json
        </div>
        
        <form id="uploadForm">
            <div class="form-group">
                <label for="testData">ğŸ¯ æµ‹è¯•æ•°æ® (éšä¾¿è¾“å…¥ç‚¹ä»€ä¹ˆ):</label>
                <input type="text" id="testData" placeholder="æ¯”å¦‚: 123, hello world, æµ‹è¯•æ•°æ®..." required>
            </div>
            
            <div class="form-group">
                <label for="userName">ğŸ‘¤ ç”¨æˆ·å (å¯é€‰):</label>
                <input type="text" id="userName" placeholder="è¾“å…¥ä½ çš„åå­—" value="æµ‹è¯•ç”¨æˆ·">
            </div>
            
            <div class="form-group">
                <label for="additionalInfo">ğŸ“ é¢å¤–ä¿¡æ¯ (å¯é€‰):</label>
                <textarea id="additionalInfo" placeholder="å¯ä»¥è¾“å…¥ä¸€äº›é¢å¤–çš„æµ‹è¯•ä¿¡æ¯..."></textarea>
            </div>
            
            <button type="button" id="testBtn" onclick="testConnection()">ğŸ” æµ‹è¯•æœåŠ¡å™¨è¿æ¥</button>
            <button type="submit" id="uploadBtn">ğŸ“¤ ä¸Šä¼ åˆ°äº‘æœåŠ¡å™¨</button>
        </form>
        
        <div id="result" class="result"></div>
    </div>

    <script>
        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const uploadBtn = document.getElementById('uploadBtn');
            const result = document.getElementById('result');
            
            // è·å–è¡¨å•æ•°æ®
            const testData = document.getElementById('testData').value;
            const userName = document.getElementById('userName').value || 'æµ‹è¯•ç”¨æˆ·';
            const additionalInfo = document.getElementById('additionalInfo').value;
            
            // æ„é€ æµ‹è¯•JSONæ•°æ®
            const testJsonData = {
                timestamp: new Date().toISOString(),
                testData: testData,
                userName: userName,
                additionalInfo: additionalInfo,
                testType: 'upload_test',
                metadata: {
                    browser: navigator.userAgent,
                    timestamp: Date.now(),
                    randomId: Math.random().toString(36).substr(2, 9)
                }
            };
            
            // æ˜¾ç¤ºä¸Šä¼ ä¸­çŠ¶æ€
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'â³ æ­£åœ¨ä¸Šä¼ ...';
            showResult('ğŸ”„ æ­£åœ¨è¿æ¥äº‘æœåŠ¡å™¨...', 'info');
            
            try {
                // åˆ›å»ºJSONæ–‡ä»¶
                const jsonBlob = new Blob([JSON.stringify(testJsonData, null, 2)], {
                    type: 'application/json;charset=utf-8;'
                });
                
                // ç”Ÿæˆæ–‡ä»¶å
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
                const filename = `test_upload_${timestamp}_${Date.now()}.json`;
                
                // å‡†å¤‡è¡¨å•æ•°æ®
                const formData = new FormData();
                formData.append('jsonFile', jsonBlob, filename);
                formData.append('userName', userName);
                formData.append('userGender', '');
                formData.append('userId', `test_${Date.now()}`);
                formData.append('uploadTime', new Date().toISOString());
                formData.append('fileType', 'upload_test');
                formData.append('totalEvents', 1);
                
                // æ£€æµ‹è¿è¡Œç¯å¢ƒå¹¶é€‰æ‹©åˆé€‚çš„ URL
                const isGitHubPages = window.location.hostname.includes('github.io');
                const uploadUrl = isGitHubPages ?
                    'https://cors-anywhere.herokuapp.com/http://106.15.184.68/api/upload-json' :
                    'http://106.15.184.68/api/upload-json';

                // å‘é€åˆ°äº‘æœåŠ¡å™¨
                console.log('ğŸŒ æ­£åœ¨å‘é€è¯·æ±‚åˆ°:', uploadUrl);
                console.log('ğŸ“¦ å‘é€çš„æ•°æ®:', formData);

                const response = await fetch(uploadUrl, {
                    method: 'POST',
                    mode: 'cors', // æ˜ç¡®æŒ‡å®š CORS æ¨¡å¼
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`ä¸Šä¼ å¤±è´¥: ${response.status} ${response.statusText}`);
                }
                
                const result_data = await response.json();
                
                showResult(`âœ… ä¸Šä¼ æˆåŠŸï¼
                ğŸ“ æ–‡ä»¶å: ${result_data.data.filename}
                ğŸ“Š æ–‡ä»¶å¤§å°: ${result_data.data.size} å­—èŠ‚
                â° ä¸Šä¼ æ—¶é—´: ${result_data.data.uploadTime}
                ğŸ¯ æµ‹è¯•æ•°æ®: "${testData}"`, 'success');
                
                // é‡ç½®è¡¨å•
                document.getElementById('testData').value = '';
                document.getElementById('additionalInfo').value = '';
                
            } catch (error) {
                console.error('âŒ ä¸Šä¼ å¤±è´¥:', error);
                console.error('é”™è¯¯ç±»å‹:', error.name);
                console.error('é”™è¯¯è¯¦æƒ…:', error.message);

                let errorMessage = `âŒ ä¸Šä¼ å¤±è´¥: ${error.message}\n\n`;

                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    errorMessage += `ğŸ” ç½‘ç»œè¿æ¥é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
                    â€¢ äº‘æœåŠ¡å™¨æ˜¯å¦å¯åŠ¨ (106.15.184.68)
                    â€¢ æœåŠ¡å™¨æ˜¯å¦è¿è¡Œåœ¨ç«¯å£ 80
                    â€¢ é˜²ç«å¢™æ˜¯å¦é˜»æ­¢äº†è¿æ¥
                    â€¢ æ˜¯å¦æœ‰ç½‘ç»œè¿æ¥`;
                } else if (error.message.includes('CORS')) {
                    errorMessage += `ğŸ” è·¨åŸŸè®¿é—®é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
                    â€¢ æœåŠ¡å™¨ CORS é…ç½®
                    â€¢ æ˜¯å¦å…è®¸æœ¬åœ°è®¿é—®`;
                } else {
                    errorMessage += `ğŸ” å¯èƒ½çš„åŸå› :
                    â€¢ ç½‘ç»œè¿æ¥é—®é¢˜
                    â€¢ æœåŠ¡å™¨æœªå¯åŠ¨
                    â€¢ API ç«¯ç‚¹ä¸å­˜åœ¨
                    â€¢ æœåŠ¡å™¨å†…éƒ¨é”™è¯¯`;
                }

                showResult(errorMessage, 'error');
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'ğŸ“¤ ä¸Šä¼ åˆ°äº‘æœåŠ¡å™¨';
            }
        });
        
        function showResult(message, type) {
            const result = document.getElementById('result');
            result.textContent = message;
            result.className = `result ${type}`;
            result.style.display = 'block';
        }

        // æµ‹è¯•æœåŠ¡å™¨è¿æ¥
        async function testConnection() {
            const testBtn = document.getElementById('testBtn');
            const originalText = testBtn.textContent;

            testBtn.disabled = true;
            testBtn.textContent = 'ğŸ”„ æµ‹è¯•ä¸­...';
            showResult('ğŸ” æ­£åœ¨æµ‹è¯•æœåŠ¡å™¨è¿æ¥...', 'info');

            try {
                // æ£€æµ‹è¿è¡Œç¯å¢ƒå¹¶é€‰æ‹©åˆé€‚çš„ URL
                const isGitHubPages = window.location.hostname.includes('github.io');
                const healthUrl = isGitHubPages ?
                    'https://cors-anywhere.herokuapp.com/http://106.15.184.68/api/health' :
                    'http://106.15.184.68/api/health';

                console.log('ğŸŒ æµ‹è¯•è¿æ¥åˆ°:', healthUrl);

                const response = await fetch(healthUrl, {
                    method: 'GET',
                    mode: 'cors'
                });

                if (response.ok) {
                    const data = await response.json();
                    showResult(`âœ… æœåŠ¡å™¨è¿æ¥æˆåŠŸï¼
                    ğŸ“ æœåŠ¡å™¨çŠ¶æ€: ${data.status}
                    â° æœåŠ¡å™¨æ—¶é—´: ${data.timestamp}
                    ğŸ’¬ æ¶ˆæ¯: ${data.message || 'æœåŠ¡å™¨è¿è¡Œæ­£å¸¸'}`, 'success');
                } else {
                    showResult(`âš ï¸ æœåŠ¡å™¨å“åº”å¼‚å¸¸
                    ğŸ“Š çŠ¶æ€ç : ${response.status}
                    ğŸ“ çŠ¶æ€æ–‡æœ¬: ${response.statusText}`, 'error');
                }

            } catch (error) {
                console.error('è¿æ¥æµ‹è¯•å¤±è´¥:', error);
                showResult(`âŒ æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨
                é”™è¯¯: ${error.message}

                è¯·æ£€æŸ¥:
                â€¢ æœåŠ¡å™¨æ˜¯å¦å¯åŠ¨ (106.15.184.68:80)
                â€¢ ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸
                â€¢ é˜²ç«å¢™è®¾ç½®`, 'error');
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = originalText;
            }
        }
    </script>
</body>
</html>
